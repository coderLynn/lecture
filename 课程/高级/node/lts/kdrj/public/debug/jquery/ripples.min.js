Fengs.add("jquery/ripples",function(e,t){function r(){var e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl"),r=t&&t.getExtension("OES_texture_float")&&t.getExtension("OES_texture_float_linear");return r}function i(e,t){function r(e,t){var r=a.createShader(e);if(a.shaderSource(r,t),a.compileShader(r),!a.getShaderParameter(r,a.COMPILE_STATUS))throw new Error("compile error: "+a.getShaderInfoLog(r));return r}var i={};if(i.id=a.createProgram(),a.attachShader(i.id,r(a.VERTEX_SHADER,e)),a.attachShader(i.id,r(a.FRAGMENT_SHADER,t)),a.linkProgram(i.id),!a.getProgramParameter(i.id,a.LINK_STATUS))throw new Error("link error: "+a.getProgramInfoLog(i.id));i.uniforms={},i.locations={},a.useProgram(i.id),a.enableVertexAttribArray(0);for(var o,n=/uniform (\w+) (\w+)/g,s=e+t;null!=(match=n.exec(s));)o=match[2],i.locations[o]=a.getUniformLocation(i.id,o);return i}function o(e,t){a.activeTexture(a.TEXTURE0+(t||0)),a.bindTexture(a.TEXTURE_2D,e)}if(t.browser.msie)return function(){};var a,n=t(window);String.prototype.endsWith=function(e){return-1!==this.indexOf(e,this.length-e.length)};r();t("head").prepend("<style>.jquery-ripples { position: relative; z-index: 0; }</style>");var s=function(e,r){function i(){o.update(),requestAnimationFrame(i)}var o=this;this.$el=e,this.$el.addClass("jquery-ripples");var n=/url\(["']?([^"']*)["']?\)/.exec(this.$el.css("background-image"));if(null!=n){n=n[1],this.resolution=r.resolution||256,this.textureDelta=new Float32Array([1/this.resolution,1/this.resolution]),this.perturbance=r.perturbance,this.dropRadius=r.dropRadius;var s=document.createElement("canvas");s.width=this.$el.innerWidth(),s.height=this.$el.innerHeight(),this.canvas=s,this.$canvas=t(s),this.$canvas.css({position:"absolute",left:0,top:0,right:0,bottom:0,zIndex:-1}),this.$el.append(s),this.context=a=s.getContext("webgl")||s.getContext("experimental-webgl"),a.getExtension("OES_texture_float"),a.getExtension("OES_texture_float_linear"),t(window).on("resize",function(){(o.$el.innerWidth()!=o.canvas.width||o.$el.innerHeight()!=o.canvas.height)&&(s.width=o.$el.innerWidth(),s.height=o.$el.innerHeight())}),this.$el.on("mousemove.ripples",function(e){o.visible&&o.dropAtMouse(e,o.dropRadius,.01)}).on("mousedown.ripples",function(e){o.visible&&o.dropAtMouse(e,1.5*o.dropRadius,.14)}),this.textures=[],this.framebuffers=[];for(var u=0;2>u;u++){var h=a.createTexture(),d=a.createFramebuffer();if(a.bindFramebuffer(a.FRAMEBUFFER,d),d.width=this.resolution,d.height=this.resolution,a.bindTexture(a.TEXTURE_2D,h),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,this.resolution,this.resolution,0,a.RGBA,a.FLOAT,null),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,h,0),a.checkFramebufferStatus(a.FRAMEBUFFER)!=a.FRAMEBUFFER_COMPLETE)throw new Error("Rendering to this texture is not supported (incomplete framebuffer)");a.bindTexture(a.TEXTURE_2D,null),a.bindFramebuffer(a.FRAMEBUFFER,null),this.textures.push(h),this.framebuffers.push(d)}this.quad=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.quad),a.bufferData(a.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,1,1,-1,1]),a.STATIC_DRAW),this.initShaders();var f=new Image;f.crossOrigin="",f.onload=function(){function e(e){return 0==(e&e-1)}a=o.context;var t=e(f.width)&&e(f.height)?a.REPEAT:a.CLAMP_TO_EDGE;o.backgroundWidth=f.width,o.backgroundHeight=f.height;var r=a.createTexture();a.bindTexture(a.TEXTURE_2D,r),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,1),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,t),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,t),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,f),o.backgroundTexture=r,o.$el.css("backgroundImage","none")},f.src=n,this.visible=!0,requestAnimationFrame(i)}};return s.DEFAULTS={resolution:256,dropRadius:20,perturbance:.03},s.prototype={update:function(){a=this.context,this.visible&&this.backgroundTexture&&(this.updateTextures(),this.render())},drawQuad:function(){a.bindBuffer(a.ARRAY_BUFFER,this.quad),a.vertexAttribPointer(0,2,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLE_FAN,0,4)},render:function(){a.viewport(0,0,this.canvas.width,this.canvas.height),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.useProgram(this.renderProgram.id),o(this.backgroundTexture,0),o(this.textures[0],1),a.uniform2fv(this.renderProgram.locations.topLeft,this.renderProgram.uniforms.topLeft),a.uniform2fv(this.renderProgram.locations.bottomRight,this.renderProgram.uniforms.bottomRight),a.uniform2fv(this.renderProgram.locations.containerRatio,this.renderProgram.uniforms.containerRatio),a.uniform1i(this.renderProgram.locations.samplerBackground,0),a.uniform1i(this.renderProgram.locations.samplerRipples,1),this.drawQuad()},updateTextures:function(){this.computeTextureBoundaries(),a.viewport(0,0,this.resolution,this.resolution);for(var e=0;2>e;e++)a.bindFramebuffer(a.FRAMEBUFFER,this.framebuffers[e]),o(this.textures[1-e]),a.useProgram(this.updateProgram[e].id),this.drawQuad();a.bindFramebuffer(a.FRAMEBUFFER,null)},computeTextureBoundaries:function(){var e=this.$el.css("background-size"),t=this.$el.css("background-attachment"),r=this.$el.css("background-position").split(" "),i="fixed"==t?n:this.$el,o=i.offset()||{left:pageXOffset,top:pageYOffset},a=i.innerWidth(),s=i.innerHeight();if("cover"==e)var u=Math.max(a/this.backgroundWidth,s/this.backgroundHeight),h=this.backgroundWidth*u,d=this.backgroundHeight*u;else if("contain"==e)var u=Math.min(a/this.backgroundWidth,s/this.backgroundHeight),h=this.backgroundWidth*u,d=this.backgroundHeight*u;else{e=e.split(" ");var h=e[0],d=e[1]||e[0];h.endsWith("%")?h=a*parseFloat(h)/100:"auto"!=h&&(h=parseFloat(h)),d.endsWith("%")?d=s*parseFloat(d)/100:"auto"!=d&&(d=parseFloat(d)),"auto"==h&&"auto"==d?(h=this.backgroundWidth,d=this.backgroundHeight):("auto"==h&&(h=this.backgroundWidth*(d/this.backgroundHeight)),"auto"==d&&(d=this.backgroundHeight*(h/this.backgroundWidth)))}var f=r[0],c=r[1];f="left"==f?o.left:"center"==f?o.left+a/2-h/2:"right"==f?o.left+a-h:f.endsWith("%")?o.left+(a-h)*parseFloat(f)/100:parseFloat(f),c="top"==c?o.top:"center"==c?o.top+s/2-d/2:"bottom"==c?o.top+s-d:c.endsWith("%")?o.top+(s-d)*parseFloat(c)/100:parseFloat(c);var l=this.$el.offset();this.renderProgram.uniforms.topLeft=new Float32Array([(l.left-f)/h,(l.top-c)/d]),this.renderProgram.uniforms.bottomRight=new Float32Array([this.renderProgram.uniforms.topLeft[0]+this.$el.innerWidth()/h,this.renderProgram.uniforms.topLeft[1]+this.$el.innerHeight()/d]);var g=Math.max(this.canvas.width,this.canvas.height);this.renderProgram.uniforms.containerRatio=new Float32Array([this.canvas.width/g,this.canvas.height/g])},initShaders:function(){var e=["attribute vec2 vertex;","varying vec2 coord;","void main() {","coord = vertex * 0.5 + 0.5;","gl_Position = vec4(vertex, 0.0, 1.0);","}"].join("\n");this.dropProgram=i(e,["precision highp float;","const float PI = 3.141592653589793;","uniform sampler2D texture;","uniform vec2 center;","uniform float radius;","uniform float strength;","varying vec2 coord;","void main() {","vec4 info = texture2D(texture, coord);","float drop = max(0.0, 1.0 - length(center * 0.5 + 0.5 - coord) / radius);","drop = 0.5 - cos(drop * PI) * 0.5;","info.r += drop * strength;","gl_FragColor = info;","}"].join("\n")),this.updateProgram=[0,0],this.updateProgram[0]=i(e,["precision highp float;","uniform sampler2D texture;","uniform vec2 delta;","varying vec2 coord;","void main() {","vec4 info = texture2D(texture, coord);","vec2 dx = vec2(delta.x, 0.0);","vec2 dy = vec2(0.0, delta.y);","float average = (","texture2D(texture, coord - dx).r +","texture2D(texture, coord - dy).r +","texture2D(texture, coord + dx).r +","texture2D(texture, coord + dy).r",") * 0.25;","info.g += (average - info.r) * 2.0;","info.g *= 0.995;","info.r += info.g;","gl_FragColor = info;","}"].join("\n")),a.uniform2fv(this.updateProgram[0].locations.delta,this.textureDelta),this.updateProgram[1]=i(e,["precision highp float;","uniform sampler2D texture;","uniform vec2 delta;","varying vec2 coord;","void main() {","vec4 info = texture2D(texture, coord);","vec3 dx = vec3(delta.x, texture2D(texture, vec2(coord.x + delta.x, coord.y)).r - info.r, 0.0);","vec3 dy = vec3(0.0, texture2D(texture, vec2(coord.x, coord.y + delta.y)).r - info.r, delta.y);","info.ba = normalize(cross(dy, dx)).xz;","gl_FragColor = info;","}"].join("\n")),a.uniform2fv(this.updateProgram[1].locations.delta,this.textureDelta),this.renderProgram=i(["precision highp float;","attribute vec2 vertex;","uniform vec2 topLeft;","uniform vec2 bottomRight;","uniform vec2 containerRatio;","varying vec2 ripplesCoord;","varying vec2 backgroundCoord;","void main() {","backgroundCoord = mix(topLeft, bottomRight, vertex * 0.5 + 0.5);","backgroundCoord.y = 1.0 - backgroundCoord.y;","ripplesCoord = vec2(vertex.x, -vertex.y) * containerRatio * 0.5 + 0.5;","gl_Position = vec4(vertex.x, -vertex.y, 0.0, 1.0);","}"].join("\n"),["precision highp float;","uniform sampler2D samplerBackground;","uniform sampler2D samplerRipples;","uniform float perturbance;","varying vec2 ripplesCoord;","varying vec2 backgroundCoord;","void main() {","vec2 offset = -texture2D(samplerRipples, ripplesCoord).ba;","float specular = pow(max(0.0, dot(offset, normalize(vec2(-0.6, 1.0)))), 4.0);","gl_FragColor = texture2D(samplerBackground, backgroundCoord + offset * perturbance) + specular;","}"].join("\n")),a.uniform1f(this.renderProgram.locations.perturbance,this.perturbance)},dropAtMouse:function(e,t,r){a=this.context,e.offsetX=e.offsetX||e.pageX-this.$el.offset().left,e.offsetY=e.offsetY||e.pageY-this.$el.offset().top;var i=this.$el.outerWidth(),n=this.$el.outerHeight(),s=Math.max(i,n);t/=s;var u=new Float32Array([(2*e.offsetX-i)/s,(n-2*e.offsetY)/s]);a.viewport(0,0,this.resolution,this.resolution),a.bindFramebuffer(a.FRAMEBUFFER,this.framebuffers[0]),o(this.textures[1]),a.useProgram(this.dropProgram.id),a.uniform2fv(this.dropProgram.locations.center,u),a.uniform1f(this.dropProgram.locations.radius,t),a.uniform1f(this.dropProgram.locations.strength,r),this.drawQuad();var h=this.framebuffers[0];this.framebuffers[0]=this.framebuffers[1],this.framebuffers[1]=h,h=this.textures[0],this.textures[0]=this.textures[1],this.textures[1]=h,a.bindFramebuffer(a.FRAMEBUFFER,null)},destroy:function(){this.canvas.remove(),this.$el.off(".ripples"),this.$el.css("backgroundImage",""),this.$el.removeClass("jquery-ripples").data("ripples",void 0)},show:function(){this.$canvas.show(),this.$el.css("backgroundImage","none"),this.visible=!0},hide:function(){this.$canvas.hide(),this.$el.css("backgroundImage",""),this.visible=!1}},s});